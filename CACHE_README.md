# Orders Service с кешированием и инвалидацией

## Описание

Проект включает полноценную систему кеширования с автоматической инвалидацией и поддержкой TTL (Time To Live). Кеш используется для ускорения ответов на запросы заказов и снижения нагрузки на базу данных.

## Основные возможности

### 1. TTL (Time To Live)
- Каждая запись в кеше имеет временную метку
- По умолчанию TTL = 30 минут (настраивается при создании)
- Автоматическая проверка TTL при каждом запросе
- Фоновая очистка устаревших записей каждые TTL/2

### 2. Thread-Safe операции
- Все операции защищены мьютексами
- Безопасный доступ из множественных горутин
- Корректное завершение при остановке сервера

### 3. Мониторинг и управление
- API для получения статистики кеша
- Ручная инвалидация отдельных записей или всего кеша
- Принудительное обновление данных из БД

## API для управления кешем

### Статистика кеша
```http
GET /cache/stats
```

**Пример ответа:**
```json
{
  "total_entries": 150,
  "expired_entries": 5,
  "valid_entries": 145,
  "ttl_minutes": 30
}
```

### Инвалидация кеша

**Полная очистка:**
```http
POST /cache/invalidate
DELETE /cache/invalidate
```

**Инвалидация конкретного заказа:**
```http
POST /cache/invalidate/{order_uid}
DELETE /cache/invalidate/{order_uid}
```

### Получение заказа с кеширования

**Обычное получение:**
```http
GET /order/{order_uid}
```

**Принудительное обновление из БД:**
```http
GET /order/{order_uid}?refresh=true
```

### Заголовки ответов
- `X-Cache: HIT` — данные взяты из кеша
- `X-Cache: MISS` — данные загружены из базы данных

## Работа с кешем (Go API)

### Инициализация
```go
// Создание кеша с TTL 30 минут
orderCache := cache.New(30 * time.Minute)
```

### Основные методы
```go
// Получение записи с проверкой TTL
order, found := orderCache.Get("order_uid")

// Добавление/обновление записи
orderCache.Set("order_uid", order)

// Удаление конкретного заказа
orderCache.Invalidate("order_uid")

// Полная очистка кеша
orderCache.InvalidateAll()

// Обновление записи из БД
orderCache.Refresh(ctx, "order_uid", repo)

// Получение статистики
stats := orderCache.GetStats()

// Безопасное завершение работы
orderCache.Close()
```

## Тестирование кеша через curl

### 1. Проверка статистики
```bash
curl -v http://localhost:8080/cache/stats
```

### 2. Проверка работы кеша

**Первый запрос (MISS):**
```bash
curl -v http://localhost:8080/order/111
# Ответ содержит: X-Cache: MISS
```

**Повторный запрос (HIT):**
```bash
curl -v http://localhost:8080/order/111
# Ответ содержит: X-Cache: HIT
```

### 3. Принудительное обновление
```bash
curl -v "http://localhost:8080/order/111?refresh=true"
```

### 4. Инвалидация

**Полная очистка:**
```bash
curl -v -X POST http://localhost:8080/cache/invalidate
# или
curl -v -X DELETE http://localhost:8080/cache/invalidate
```

**Инвалидация конкретного заказа:**
```bash
curl -v -X POST http://localhost:8080/cache/invalidate/111
# или
curl -v -X DELETE http://localhost:8080/cache/invalidate/111
```

## Логирование

Система логирует следующие события:
- Загрузку данных из БД в кеш
- Автоматическую очистку устаревших записей
- Операции ручной инвалидации
- Принудительное обновление кеша
- Статистику производительности

**Просмотр логов:**
```bash
docker logs <container_name>
```

## Архитектурные детали

### Структура записи кеша
```go
type CacheEntry struct {
    Order     models.Order
    Timestamp time.Time
}
```

### Безопасность
- Все операции с кешем используют `sync.RWMutex`
- Горутина очистки корректно завершается при остановке сервера
- Защита от гонок при одновременном доступе

## Преимущества

1. **Автоматическая инвалидация** — устаревшие данные удаляются без вмешательства
2. **Принудительное обновление** — возможность обновить кеш по требованию
3. **Мониторинг** — полная статистика работы кеша через API
4. **Безопасность** — thread-safe операции для многопоточного окружения
5. **Производительность** — значительное снижение нагрузки на БД
6. **Управляемость** — полный контроль над кешем через REST API

## Конфигурация

### Настройка TTL
TTL кеша настраивается при создании экземпляра:
```go
// В main.go
orderCache := cache.New(30 * time.Minute)
```

### Рекомендуемые значения TTL:
- **Разработка:** 5-10 минут
- **Тестирование:** 15-30 минут
- **Продакшн:** 30-60 минут

### Автоматическая очистка
Частота фоновой очистки автоматически устанавливается как `TTL/2`

## Сценарий тестирования

1. Запустите сервер
2. Проверьте статистику: `curl http://localhost:8080/cache/stats`
3. Загрузите заказ: `curl -v http://localhost:8080/order/111` (MISS)
4. Повторите запрос: `curl -v http://localhost:8080/order/111` (HIT)
5. Инвалидируйте: `curl -X POST http://localhost:8080/cache/invalidate/111`
6. Проверьте снова: `curl -v http://localhost:8080/order/111` (MISS)
